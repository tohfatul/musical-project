<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music site</title>
    <link rel="stylesheet" href="/css/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/fontawesome/css/all.min.css">

    <script>

        window.onload = function () {


            // document.getElementById('frmLogout').style.display = 'none';
            // document.getElementById('frmLogin').style.display = 'block';

            // document.getElementById('before-login').style.display = 'block';
            // document.getElementById('after-login').style.display = 'none';

            // sessionStorage.clear();

            populatePage();

            document.getElementById('logout').onclick = function () {
                sessionStorage.clear();

                // let xx = document.getElementById('showInvalid');
                // xx.style.display = 'none';
                // document.getElementById('frmLogout').style.display = 'none';
                // document.getElementById('frmLogin').style.display = 'block';

                // document.getElementById('txtUserName').value = '';
                // document.getElementById('txtPassword').value = '';

                // document.getElementById('before-login').style.display = 'block';
                // document.getElementById('after-login').style.display = 'none';

                populatePage();

                clearMusicList();
                console.log('loged out');

            };

            document.getElementById('btnLogin').onclick = function () {
                sessionStorage.clear();
                let loginInfo = {
                    username: document.getElementById('txtUserName').value,
                    password: document.getElementById('txtPassword').value
                };
                fetch("http://localhost:3000/login", {
                    method: 'POST',
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(loginInfo)
                })
                    .then((res) => res.json())
                    .then((res) => {

                        //document.getElementById('username').innerHTML=res.username;
                        sessionStorage.setItem('username', res.username);

                        document.getElementById('txtUserName').value = '';
                        document.getElementById('txtPassword').value = '';


                        populatePage();


                    });
            }

        }

        function populatePage() {
            console.log(sessionStorage.getItem('username'));
            clearMusicList();
            if (sessionStorage.getItem('username') === 'not ok') {

                document.getElementById('showInvalid').display = 'block';

                document.getElementById('frmLogout').style.display = 'none';
                document.getElementById('frmLogin').style.display = 'block';

                document.getElementById('before-login').style.display = 'block';
                document.getElementById('after-login').style.display = 'none';
                

            }

            if (sessionStorage.getItem('username') !== 'not ok' || sessionStorage.getItem('username') !== null) {
                document.getElementById('showInvalid').display = 'none';

                document.getElementById('frmLogout').style.display = 'block';
                document.getElementById('frmLogin').style.display = 'none';

                document.getElementById('before-login').style.display = 'none';
                document.getElementById('after-login').style.display = 'block';

                document.getElementById('welcomeuser').innerHTML = 'Welcome, ' + sessionStorage.getItem('username');

                fetch("http://localhost:3000/musics")
                    .then((res) => res.json())
                    .then((res) => {


                        buildMusicList(res);
                    });

                fetch("http://localhost:3000/myMusics")
                    .then((res) => res.json())
                    .then((res) => {


                        buildMyMusic(res);
                    });


            }

            if (sessionStorage.getItem('username') === null) {

                document.getElementById('showInvalid').display = 'none';
                document.getElementById('frmLogout').style.display = 'none';
                document.getElementById('frmLogin').style.display = 'block';

                document.getElementById('before-login').style.display = 'block';
                document.getElementById('after-login').style.display = 'none';

            }
        }

        function buildMyMusic(data) {
            var table = document.getElementById('myMusicList');
            for (let i = 0; i < data.length; i++) {
                let rw = `<tr>
                            <td>${data[i].id}</td>
                            <td>${data[i].title}</td>
                            
                            <td>
                                <button onclick="addToFavourite(${data[i]})">
                                    <i class="fa-solid fa-plus"></i>
                                    </button>
                                
                            </td>
                        </tr>`

                table.innerHTML += rw;
            }
        }

        function buildMusicList(data) {

            var table = document.getElementById('musicList');
            for (let i = 0; i < data.length; i++) {
                let rw = `<tr>
                            <td>${data[i].id}</td>
                            <td>${data[i].title}</td>
                            <td>${data[i].releasedate}</td>
                            <td>
                                <button onclick="addToFavourite(${data[i].id})">
                                    <i class="fa-solid fa-plus"></i>
                                    </button>
                                
                            </td>
                        </tr>`

                table.innerHTML += rw;
            }
        }

        function clearMusicList() {
            let table = document.getElementById("musicList");
            table.innerHTML = "";
        }

        function addToFavourite(val) {
           
            let obj ={
                id:val,
                title:'something',
                user: sessionStorage.getItem('username')
            }
            //val.user = sessionStorage.getItem('username');

            console.log(JSON.stringify(obj));
            fetch("http://localhost:3000/myMusics", {
                method: 'POST',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(obj)
            })
                .then((res) => res.json())
                .then((res) => {

                    //document.getElementById('username').innerHTML=res.username;
                    // sessionStorage.setItem('username', res.username);

                    // document.getElementById('txtUserName').value='';
                    // document.getElementById('txtPassword').value='';


                    // populatePage();

                    // fetch("http://localhost:3000/myMusics")
                    //     .then((res) => res.json())
                    //     .then((res) => {
                    //         buildMyMusic(res);
                    //     });

                });

            
        }
    </script>
</head>

<body>

    <div class="container">
        <br>
        <!-- <p id="username">

        </p>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                </tr>
            </thead>

            <tbody id="myTable">

            </tbody>
        </table> -->
        <div class="row">

            <div class="col-sm-4">
                <img src="/img/circle-music.jpg" alt="" width="25%">
            </div>
            <div class="col-sm-8">
                <div id="frmLogin" name="frmLogin" class="float-right">
                    <div class="form-inline">
                        <label for="txtUserName">User Name</label>
                        <input type="text" id="txtUserName" name="username"
                            class="form-control form-control-sm ml-2 mr-2">

                        <label for="txtPassword">Password</label>
                        <input type="password" id="txtPassword" name="password"
                            class="form-control form-control-sm ml-2 mr-2">

                        <button class="btn btn-primary btn-sm" id="btnLogin">Login</button>

                    </div>
                    <br>
                    <span id="showInvalid" style="display: none;" class="text-danger float-right">Invalid username/
                        password</span>

                </div>

                <div id="frmLogout" class="float-right">
                    <div class="form-inline">
                        <input type="text" class="form-control form-control-sm mr-2" placeholder="serach">
                        <button class="btn btn-default btn-sm mr-2">Search</button>
                        <label for="" id="welcomeuser">Welcome</label>
                        <button id="logout" class="btn btn-danger btn-sm ml-2">Logout</button>
                    </div>
                </div>


            </div>
        </div>
        <!-- //header row -->

        <div class="row">
            <div class="col-sm-12 text-center" id="before-login">
                <br>
                <h2>Welcome to Music website</h2>
            </div>

            <div class="col-sm-12 text-center" id="after-login">
                <h2>Song you may interest</h2>

                <br>
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th width="10%">Id</th>
                            <th width="70%">Title</th>
                            <th width="10%">Release Date</th>
                            <th width="10%">Actions</th>

                        </tr>
                    </thead>

                    <tbody id="musicList">

                    </tbody>
                </table>

                <br>

                <h2>Your playlist</h2>
                <p>No songs in your playlist</p>
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th width="10%">S/L</th>
                            <th width="70%">Title</th>
                            <th width="20%">actions</th>

                        </tr>
                    </thead>

                    <tbody id="myMusicList">
                        <tr>
                            <td>1</td>
                            <td>See you again</td>

                            <td><i class="fa-solid fa-minus mr-3"></i> <i class="fa-solid fa-play"></i></td>
                        </tr>

                        <tr>
                            <td>2</td>
                            <td>Baby baby</td>

                            <td><i class="fa-solid fa-minus mr-3"></i> <i class="fa-solid fa-play"></i></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>


</body>

</html>